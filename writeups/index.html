<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Writeups · Offband</title>
  <meta name="description" content="Operator‑grade tutorials, homelab notes, and security experiments — built in public." />
  <link rel="preload" href="/assets/site.css" as="style">
  <link rel="stylesheet" href="/assets/site.css" />
  <script defer src="/assets/include.js"></script>
  <script defer src="/assets/sidebar.js"></script>
  <script src="/assets/writeups-data.js"></script>
</head>
<body class="has-hero">
  <div data-include="/components/topbar.html"></div>

  <div class="layout">
    <aside id="sidebar" data-include="/components/sidebar.html"></aside>

    <main id="content" class="content">
      <section class="card hero">
        <h1 class="brandmark">
          <img class="logo-badge" src="/assets/logo-badge.svg" alt="" aria-hidden="true" />
          Writeups
        </h1>
        <p class="lede">Operator‑grade tutorials, case studies, and field notes — built in public.</p>
        <p class="subtle">What you’ll find here: reproducible steps, tight scope, and real "issues → fixes" with trade‑offs explained in plain language.</p>
      </section>

      <!-- Library tools: search + categories -->
      <section class="card" aria-label="Library tools">
        <div class="searchbar" role="search">
          <input id="wu-search" type="search" placeholder="Search writeups (title, keywords)…" aria-label="Search writeups" />
          <button class="btn" id="wu-clear" aria-label="Clear search">Clear</button>
        </div>
        <div class="hr"></div>
        <div class="cats" aria-label="Categories">
          <button class="pill" data-filter="all" aria-pressed="true">All</button>
          <button class="pill" data-filter="security">Security</button>
          <button class="pill" data-filter="networking">Networking</button>
          <button class="pill" data-filter="tooling">Tooling</button>
          <button class="pill" data-filter="meta">Meta</button>
        </div>
      </section>

      <!-- Auto‑featured: last three posts (error‑tolerant) -->
      <section class="card" aria-label="Featured writeups">
        <h2>Featured</h2>
        <div id="featured-grid" class="cards"></div>
        <p class="small muted" id="featured-empty" hidden>No posts yet — they’ll appear here as you publish.</p>
      </section>

      <!-- Categories visual (button table) -->
      <section class="card" aria-label="Explore by category">
        <h2>Explore by category</h2>
        <div class="cards" id="cat-cards">
          <article class="card"><h3>Security</h3><p class="muted">Hardening, monitoring, incident notes.</p></article>
          <article class="card"><h3>Networking</h3><p class="muted">DNS, TLS, proxies, routing.</p></article>
          <article class="card"><h3>Tooling</h3><p class="muted">Scripts, pipelines, automation.</p></article>
          <article class="card"><h3>Meta</h3><p class="muted">Project structure, writing process.</p></article>
        </div>
      </section>

      <section class="card">
        <h2>All writeups</h2>
        <ul id="all-writeups" class="list-tight">
        </ul>
      </section>

      <footer data-include="/components/footer.html"></footer>
    </main>
  </div>
<script>
(async function(){
  const POSTS_DIR = '/writeups/posts/';
  const list = document.getElementById('all-writeups');
  const featured = document.getElementById('featured-grid');
  const featuredEmpty = document.getElementById('featured-empty');
  const search = document.getElementById('wu-search');
  const clearBtn = document.getElementById('wu-clear');
  const catBar = document.querySelector('.cats');

  if (!list) return;

  const norm = (p) => (/^https?:\/\//i.test(p) ? new URL(p).pathname : p).replace(/\/+$/, '');
  const byDateDesc = (a,b) => (b.dateMs||0) - (a.dateMs||0);

  async function fetchHTML(url){
    const res = await fetch(url, {credentials:'omit'});
    if(!res.ok) throw new Error('fetch failed ' + url);
    const html = await res.text();
    return new DOMParser().parseFromString(html, 'text/html');
  }

  async function discoverPosts(){
    if (window.WriteupsData && typeof window.WriteupsData.discoverPosts === 'function') {
      return window.WriteupsData.discoverPosts();
    }
    return [];
  }

  function parseDateFromFilename(path){
    const m = (path||'').match(/(\d{4}-\d{2}-\d{2})/);
    return m ? m[1] : null;
  }

  async function hydratePost(url){
    try{
      const doc = await fetchHTML(url);
      const title = (doc.querySelector('h1')?.textContent||'').trim() || url.split('/').pop().replace(/[-_]/g,' ').replace(/\.html?$/,'');
      const timeEl = doc.querySelector('time[datetime]');
      const iso = timeEl?.getAttribute('datetime') || parseDateFromFilename(url) || '';
      const dateMs = iso ? Date.parse(iso) : 0;
      const chips = Array.from(doc.querySelectorAll('.badge-chip')).map(x => (x.textContent||'').trim().toLowerCase());
      // Pick a primary category from tags if present
      const catOrder = ['security','networking','tooling','meta'];
      const cat = chips.find(t => catOrder.includes(t)) || (chips[0]||'meta');
      return { url, title, iso, dateMs, tags: chips, cat };
    } catch(e){
      const iso = parseDateFromFilename(url) || '';
      return { url, title: url.split('/').pop(), iso, dateMs: iso?Date.parse(iso):0, tags: [], cat: 'meta' };
    }
  }

  function renderFeatured(posts){
    featured.innerHTML = '';
    const pick = posts.slice(0,3);
    pick.forEach(p => {
      const card = document.createElement('article');
      card.className = 'card';
      // a subtle unique header SVG for flair
      const deco = document.createElementNS('http://www.w3.org/2000/svg','svg');
      deco.setAttribute('viewBox','0 0 120 24');
      deco.setAttribute('width','100%');
      deco.setAttribute('height','24');
      const line = document.createElementNS('http://www.w3.org/2000/svg','path');
      line.setAttribute('d','M2 12 Q 20 2 40 12 T 78 12 T 118 12');
      line.setAttribute('fill','none');
      line.setAttribute('stroke','currentColor');
      line.setAttribute('stroke-opacity','0.25');
      line.setAttribute('stroke-width','2');
      deco.appendChild(line);

      const h = document.createElement('h3'); h.textContent = p.title;
      const meta = document.createElement('p'); meta.className='small muted'; meta.textContent = p.iso || '';
      const tagrow = document.createElement('p');
      (p.tags||[]).slice(0,4).forEach(t=>{
        const span = document.createElement('span');
        span.className = 'badge-chip';
        span.textContent = t;
        tagrow.appendChild(span);
        tagrow.appendChild(document.createTextNode(' '));
      });
      const link = document.createElement('a');
      link.className = 'btn';
      link.href = p.url; link.textContent = 'Read';

      card.append(deco,h,meta,tagrow,link);
      featured.appendChild(card);
    });
    featuredEmpty.hidden = pick.length > 0;
  }

  function renderAll(posts){
    list.innerHTML = '';
    posts.forEach(p => {
      const li = document.createElement('li');
      if (p.tags?.length) li.setAttribute('data-tags', p.tags.join(','));
      const a = document.createElement('a'); a.href = p.url; a.textContent = p.title;
      li.appendChild(a); list.appendChild(li);
    });
  }

  // Fallback: read /writeups/posts/index.json accepting strings OR objects
  async function fetchManifestUrls(){
    try {
      const res = await fetch('/writeups/posts/index.json', { credentials: 'omit', cache: 'no-cache' });
      if (!res.ok) return [];
      const data = await res.json();
      if (!Array.isArray(data)) return [];
      return data.map(entry => {
        if (typeof entry === 'string') return entry; // already an href
        if (entry && typeof entry === 'object') {
          if (entry.href) return entry.href;
          if (entry.file) return `/writeups/posts/${String(entry.file).replace(/^\/*/, '')}`;
        }
        return null;
      }).filter(Boolean);
    } catch { return []; }
  }

  // DISCOVER + HYDRATE
  let posts = [];
  try{
    let urls = await discoverPosts();
    if (!urls || !urls.length) {
      // Fallback: parse our local manifest even if entries are objects
      urls = await fetchManifestUrls();
    }
    const hydrated = await Promise.all((urls || []).map(hydratePost));
    posts = hydrated.sort(byDateDesc);
  }catch(e){ /* leave posts empty */ }

  // FALLBACK: if still empty, keep whatever was in the static list
  if (!posts.length){
    const fallback = Array.from(list.querySelectorAll('a')).map(a=>({url:a.href,title:a.textContent||a.href, iso:'', dateMs:0, tags:[], cat:'meta'}));
    posts = fallback;
  } else {
    renderAll(posts);
  }

  // FEATURED (top 3 or fewer)
  try{ renderFeatured(posts); } catch(_){}

  // FILTERING (search + categories)
  function items(){ return Array.from(list.querySelectorAll('li')); }
  function textOf(el){ return (el.textContent||'').toLowerCase(); }

  let activeCat = 'all';
  function applyFilter(){
    const q = (search && search.value || '').toLowerCase();
    items().forEach(li => {
      const tags = (li.getAttribute('data-tags')||'').toLowerCase();
      const title = textOf(li);
      const catHit = (activeCat==='all') || tags.includes(activeCat) || title.includes(activeCat);
      const qHit = !q || title.includes(q) || tags.includes(q);
      li.style.display = (catHit && qHit) ? '' : 'none';
    });
  }

  if (search){ search.addEventListener('input', applyFilter); }
  if (clearBtn){ clearBtn.addEventListener('click', () => { search.value=''; applyFilter(); }); }
  if (catBar){
    catBar.addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-filter]');
      if (!b) return;
      activeCat = b.dataset.filter;
      catBar.querySelectorAll('button[data-filter]').forEach(x=>x.setAttribute('aria-pressed', x===b ? 'true':'false'));
      applyFilter();
    });
  }

  applyFilter();
})();
</script>
</body>
</html>
